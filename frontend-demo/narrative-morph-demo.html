<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ NarrativeMorph - Storia ‚Üí Video in 5 minuti</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: inline-block;
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .file-label:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .title-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            margin: 15px 0;
            transition: border-color 0.3s ease;
        }

        .title-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-section {
            background: #f7fafc;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .status-section.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-text {
            font-size: 1.1em;
            margin: 10px 0;
            color: #4a5568;
        }

        .results-section {
            background: #f0fff4;
            border-radius: 15px;
            padding: 30px;
            display: none;
            text-align: center;
        }

        .results-section.show {
            display: block;
        }

        .download-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 10px;
        }

        .download-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .view-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 10px;
        }

        .view-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .demo-stories {
            margin-top: 30px;
            text-align: center;
        }

        .demo-story-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-story-btn:hover {
            background: #cbd5e0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .processing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ NarrativeMorph</h1>
            <p>Trasforma la tua storia in un video in 5 minuti!</p>
        </div>

        <div class="main">
            <!-- Upload Section -->
            <div class="upload-section">
                <h2>üìñ Carica la tua storia</h2>
                <p>Supporta file .txt e .md (massimo 2MB)</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".txt,.md">
                    <label for="fileInput" class="file-label">üìÅ Scegli file</label>
                </div>
                
                <input type="text" id="titleInput" class="title-input" placeholder="Titolo del progetto (opzionale)">
                
                <button id="uploadBtn" class="upload-btn" disabled>üöÄ Genera Video</button>
                
                <div id="errorMessage" class="error"></div>

                <div class="demo-stories">
                    <h4>üìö Storie demo veloci:</h4>
                    <button class="demo-story-btn" onclick="loadDemoStory('drago')">üêâ Il Drago Fuoco</button>
                    <button class="demo-story-btn" onclick="loadDemoStory('principessa')">üë∏ La Principessa Coraggiosa</button>
                    <button class="demo-story-btn" onclick="loadDemoStory('robot')">ü§ñ Il Robot Amichevole</button>
                </div>
            </div>

            <!-- Status Section -->
            <div id="statusSection" class="status-section">
                <h2>‚öôÔ∏è Generazione in corso...</h2>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="statusText" class="status-text">Inizializzazione...</div>
                <div id="currentStep" class="status-text"></div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section">
                <h2>üéâ Video completato!</h2>
                <p>Il tuo video √® pronto per il download</p>
                <div>
                    <button id="downloadBtn" class="download-btn">üíæ Scarica Video</button>
                    <button id="viewBtn" class="view-btn">üëÅÔ∏è Visualizza</button>
                </div>
                <div id="videoInfo" class="status-text"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        let currentProjectId = null;
        let statusCheckInterval = null;

        // Demo stories
        const demoStories = {
            drago: `Il Piccolo Drago Fuoco

C'era una volta un piccolo drago di nome Fuoco che viveva in una montagna magica. Aveva scaglie rosse brillanti e poteva sputare piccole fiamme colorate.

Un giorno, Fuoco scopr√¨ che la sua famiglia era in pericolo. Un malvagio stregone aveva lanciato un incantesimo che stava trasformando tutti i draghi in pietra.

Fuoco decise di partire per un'avventura epica. Vol√≤ attraverso foreste incantate, incontr√≤ fate sagge che gli diedero consigli preziosi, e combatt√© contro creature oscure.

Dopo molte sfide e prove di coraggio, Fuoco riusc√¨ a trovare la pozione magica che poteva spezzare l'incantesimo. Torn√≤ velocemente a casa e salv√≤ tutta la sua famiglia.

Da quel giorno, Fuoco divenne il drago eroe della montagna magica, proteggendo tutti gli abitanti del regno fantastico.`,

            principessa: `La Principessa Coraggiosa

In un regno lontano viveva la Principessa Luna, conosciuta per la sua saggezza e il suo coraggio. Non amava stare chiusa nel castello, preferiva esplorare il mondo.

Un giorno, un drago cattivo rap√¨ tutti i bambini del villaggio e li port√≤ nella sua caverna buia. Il re era disperato e non sapeva cosa fare.

La Principessa Luna decise di agire. Si vest√¨ da cavaliere, prese la sua spada magica e part√¨ alla ricerca del drago. Attravers√≤ boschi pericolosi e scal√≤ montagne ripide.

Quando trov√≤ la caverna, invece di combattere, parl√≤ con il drago. Scopr√¨ che era solo e triste, e voleva solo degli amici con cui giocare.

La principessa convinse il drago a liberare i bambini e gli promise che sarebbero venuti a trovarlo spesso per giocare insieme. Cos√¨ tutti vissero felici e contenti.`,

            robot: `Il Robot Amichevole

In una citt√† del futuro, uno scienziato invent√≤ un robot speciale chiamato R2-Amico. Era diverso dagli altri robot perch√© aveva un cuore elettronico pieno di gentilezza.

R2-Amico amava aiutare le persone: portava la spesa agli anziani, aiutava i bambini a fare i compiti e riparava tutto quello che si rompeva in citt√†.

Un giorno, un virus informatico attacc√≤ tutti i computer della citt√†. Le macchine impazzirono e tutto and√≤ in tilt: semafori, ascensori, persino i forni delle pizzerie!

R2-Amico cap√¨ che doveva fermare il virus. Entr√≤ nel sistema informatico centrale e combatt√© contro il virus usando la sua programmazione speciale basata sull'amore e l'amicizia.

Dopo una battaglia digitale epica, R2-Amico sconfisse il virus e salv√≤ la citt√†. Tutti festeggiarono il loro eroe robotico con una grande parata.`
        };

        // File input handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (file) {
                if (file.size > 2 * 1024 * 1024) { // 2MB
                    showError('File troppo grande. Massimo 2MB.');
                    uploadBtn.disabled = true;
                    return;
                }
                
                if (!file.name.match(/\.(txt|md)$/)) {
                    showError('Formato file non supportato. Usa .txt o .md');
                    uploadBtn.disabled = true;
                    return;
                }
                
                uploadBtn.disabled = false;
                hideError();
                
                // Auto-fill title
                const titleInput = document.getElementById('titleInput');
                if (!titleInput.value) {
                    titleInput.value = file.name.replace(/\.(txt|md)$/, '');
                }
            } else {
                uploadBtn.disabled = true;
            }
        });

        // Upload button
        document.getElementById('uploadBtn').addEventListener('click', uploadStory);

        // Demo story loader
        function loadDemoStory(type) {
            const story = demoStories[type];
            const blob = new Blob([story], { type: 'text/plain' });
            const file = new File([blob], `${type}_demo.txt`, { type: 'text/plain' });
            
            // Create a FileList-like object
            const dt = new DataTransfer();
            dt.items.add(file);
            document.getElementById('fileInput').files = dt.files;
            
            // Trigger change event
            const event = new Event('change', { bubbles: true });
            document.getElementById('fileInput').dispatchEvent(event);
            
            // Set title
            document.getElementById('titleInput').value = `Demo: ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        }

        async function uploadStory() {
            const fileInput = document.getElementById('fileInput');
            const titleInput = document.getElementById('titleInput');
            
            if (!fileInput.files[0]) {
                showError('Seleziona un file prima di caricare.');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (titleInput.value) {
                formData.append('title', titleInput.value);
            }

            try {
                showStatus('Caricamento storia...', 0);
                
                const response = await fetch(`${API_BASE}/stories/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }

                const result = await response.json();
                currentProjectId = result.project_id;
                
                showStatus('Storia caricata! Iniziando la generazione...', 10);
                startStatusCheck();
                
            } catch (error) {
                console.error('Upload error:', error);
                showError(`Errore durante l'upload: ${error.message}`);
                hideStatus();
            }
        }

        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(checkStatus, 2000); // Check every 2 seconds
            checkStatus(); // Initial check
        }

        async function checkStatus() {
            if (!currentProjectId) return;

            try {
                const response = await fetch(`${API_BASE}/projects/${currentProjectId}/status`);
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }

                const status = await response.json();
                updateStatusDisplay(status);

                if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    showResults(status);
                } else if (status.status === 'failed') {
                    clearInterval(statusCheckInterval);
                    showError(`Errore durante la generazione: ${status.error || 'Errore sconosciuto'}`);
                    hideStatus();
                }
            } catch (error) {
                console.error('Status check error:', error);
                showError(`Errore controllo stato: ${error.message}`);
                clearInterval(statusCheckInterval);
                hideStatus();
            }
        }

        function updateStatusDisplay(status) {
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');
            const currentStep = document.getElementById('currentStep');

            progressFill.style.width = `${status.progress}%`;
            
            const statusMessages = {
                'uploaded': 'Storia caricata, iniziando analisi...',
                'analyzing': 'Analizzando le scene della storia...',
                'generating_images': 'Generando immagini per le scene...',
                'generating_audio': 'Creando narrazione audio...',
                'assembling_video': 'Assemblando il video finale...',
                'processing': 'Elaborazione in corso...',
                'completed': 'Completato!'
            };

            statusText.textContent = statusMessages[status.status] || `Stato: ${status.status}`;
            currentStep.textContent = `Progresso: ${status.progress}% | Scene: ${status.scenes_count || 0}`;
        }

        function showResults(status) {
            hideStatus();
            const resultsSection = document.getElementById('resultsSection');
            const videoInfo = document.getElementById('videoInfo');
            
            videoInfo.textContent = `Scene generate: ${status.scenes_count} | Creato: ${new Date(status.created_at).toLocaleString()}`;
            
            resultsSection.classList.add('show');
            
            // Setup download button
            document.getElementById('downloadBtn').onclick = () => {
                window.open(`${API_BASE}/projects/${currentProjectId}/download`, '_blank');
            };
            
            // Setup view button (placeholder)
            document.getElementById('viewBtn').onclick = () => {
                alert('Funzione visualizzazione in sviluppo. Usa il pulsante Download per scaricare il video.');
            };
        }

        function showStatus(message, progress) {
            hideError();
            const statusSection = document.getElementById('statusSection');
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');
            
            statusSection.classList.add('show');
            progressFill.style.width = `${progress}%`;
            statusText.textContent = message;
            
            // Add processing animation
            statusSection.classList.add('processing');
        }

        function hideStatus() {
            const statusSection = document.getElementById('statusSection');
            statusSection.classList.remove('show', 'processing');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('show');
        }

        // Reset form
        function resetForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('titleInput').value = '';
            document.getElementById('uploadBtn').disabled = true;
            hideError();
            hideStatus();
            document.getElementById('resultsSection').classList.remove('show');
            currentProjectId = null;
            
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        }

        // Auto-refresh projects list (optional)
        async function loadRecentProjects() {
            try {
                const response = await fetch(`${API_BASE}/projects`);
                if (response.ok) {
                    const projects = await response.json();
                    // Display recent projects if needed
                    console.log('Recent projects:', projects);
                }
            } catch (error) {
                console.log('Could not load recent projects:', error);
            }
        }

        // Load recent projects on page load
        loadRecentProjects();
    </script>
</body>
</html>
